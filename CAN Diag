Diagnostic Communication
"Diag CAN"是CAN诊断，即对CAN网络各个节点和总线的故障检查与修复。
一、诊断的基本知识
一般来说对于汽车的ECU诊断有以下两种方式：
·on-board diagnostics(OBD,车载诊断系统,オンボード診断)：ECU自我诊断
·off-board diagnostics(离线诊断,オンボード診断):通过和外接的诊断tester通信，接收指示并做出特别动作
（有的时候off-board diagnostics也被叫做OBD）

·诊断connecter
因为在用离线诊断的时候ECU必须和诊断tester连接，把线束(wire harness)改造延长的工作很麻烦，所以设置了专用的connecter。

二、用于诊断的通信
·Diag通信(Diagnostic Communication)
对于Diag通信，从原理上来说怎样的顺序都是可以的。但是各个公司和各个汽车甚至是各个系统的通信顺序总是各种各样的，诊断功能在使用起来比较麻烦。
因此，随着电子控制系统的发展和通信程序的标准化，现在基本上是按照下面的顺序进行的。
①从诊断tester发送请求消息(Request message)作为传达给ECU的指示。
②在指示能够被执行的情况下，ECU按照执行去做并展示出“指示已经被执行”以及“指示执行后的结果”、将它们作为正响应码(positive response message)发送。
③如果因为某种原因指示无法被执行，ECU将展示出“只是无法被执行”以及“无法执行的理由”作为负响应码(NRC, negative response message)发送

ECU无法执行诊断测试器指示的情况有几种可能。
可能是因为请求消息的格式或数据值错误而无法执行指示，或者为了安全考虑而无法执行指示（例如车辆正在行驶）。
当诊断测试器从ECU接收到负响应时，会据此中止一系列的诊断处理。

正响应码和负响应码统称为响应码。另外，请求消息和响应消息合起来称为诊断消息。

·诊断消息的收件人类型
诊断消息一般从一个连接了多个ECU的CAN Bus获取。因此必须要指定诊断消息的收信人。
指定方法有两种，分别是物理寻址(Physical Addressing)和功能寻址(Functional Addressing)。
①物理寻址
这是从一个诊断测试仪向一个ECU传达指令，或者从一个ECU向一个诊断测试仪报告结果的目标指定方法。
所有具有诊断通信功能的ECU都支持物理寻址。使用物理寻址指定的目标称为物理地址。
②功能寻址
这是用于将一个诊断tester的指令传达给一组ECU的目的地指定方法。
所包含的ECU可以只有一个，也可以有多个。设立一个包含总线上所有ECU的组也是很常见的。
通过功能寻址指定的目的地称为功能地址（图6）。
在车辆制造过程中，如果需要删除记录的故障信息，或者在进行ECU重写时，有临时停止重写对象以外的ECU的通信功能等情况，通常希望对总线上的所有ECU执行相同的处理。
此时使用功能寻址，可以通过诊断tester一次性向多个ECU发出指令，从而大幅简化此类处理。
对此，ECU 的响应消息总是发送给发送请求的那台诊断tester，因此只使用物理寻址。

·响应回复时间
接收到诊断请求的ECU会在规定时间内回复响应消息。
如果诊断tester在该时间内未收到响应，除后文所述的“正响应抑制”例外情况外，将判断请求或响应的发送接收出现异常，并在必要时重新发送请求或发送新的请求。
该响应接收的超时时间(timeout, タイムアウト)被称为P2。
P2的具体数值由汽车制造商规定，但一般为几十毫秒左右。

如果要求进行如EEPROM数据重写等耗时的处理，并且在该P2时间内处理未完成，ECU会在接收到请求后继续处理，但会通知未完成。
这种特殊的否定响应被称为响应挂起(RCRRP, Request Correctly Received-Response Pending）。
如果接收到该 RCRRP 的否定响应，诊断tester将重新等待最终响应。
此时，响应将延长 P2 时间，并将 P2*（称为 P2 增强或 P2 延长）作为超时时间。
ECU 在发送 RCRRP 否定响应后，会在“延长的 P2” = “P2*” 时间内回复最终响应。
如果在 P2* 时间即将到期时仍无法返回最终响应，则会再次发送 RCRRP 否定响应。
通常 P2* 时间设定为约 5 秒。

一般来说，这些处理都是由诊断测试仪自动完成的。但是，有时也需要自己设置或更改P2和P2*的值。

·正响应抑制
在请求消息里面，存在要求不要发送正响应码的情况（后面会讲到的UDS程序的功能）。
这个要求是通过设置嵌入在诊断请求中的称为 SPRMIB(Suppress Positive Response Message Indication Bit) 的标志(flag)来完成的。
当接收到此请求时，如果ECU能够按照诊断请求的指示执行，只会执行指示，不会回复正响应消息。
如果无法执行指示，则会回复负响应消息。
如果诊断tester在上述P2时间内没有收到响应消息，将假定发送请求的ECU正在按照自身的指示执行，并继续处理。

在大多数情况下，抑制正响应的功能用于通过功能寻址发送的请求消息。
由于不再需要处理接收正响应，因此可以进一步简化向总线上多个ECU发出相同指令的处理。

三、各种网络下的Diag通信
ECU的诊断用到了各种各样的物理层网络。虽然现在最广泛使用的是CAN通信，通过Ethernet、FlexRay、LIN、K-Line来进行诊断的情况也是存在的。
今后，通过以太网(Ethernet)进行诊断（DoIP）的情况可能会越来越多。

·使用CAN的Diag通信
现在，由于被诊断的 ECU 通常已经通过 CAN 网络连接，因此可以在不增加额外硬件的情况下实现诊断功能，并且可以获得足够的通信速度。
在使用CAN进行诊断通信时，会为诊断消息的发送方、接收方以及目标类型（物理或功能）组合分配一个CAN-ID。
将诊断消息嵌入分配好的CAN消息的数据字段中进行交换（见图7）。

·CAN-ID的作用
CAN-ID 的分配方法有多种规范可供使用。
发送方、接收方和目标类型的各个项目与 CAN-ID 之间完全没有关联，而是对这些组合分配一个 CAN-ID，这种分配方式称为普通寻址（Normal Addressing）。
此外，还有一种方法是为发送方和接收方类型的组合分配一个CAN-ID，并将接收方嵌入到数据字段的首字节中（扩展寻址，Extended Addressing）；
或者将29位CAN-ID分为4部分：5位/8位/8位/8位，并用下位的3个字节分别表示接收方类型/接收方/发送方的方法（普通固定寻址，Normal Fixed Addressing）（见图9）。
为了进行通过网关的诊断，也有一种方法是将网关另一端网络的接收方同样嵌入数据字段的首字节中（混合寻址，Mixed Addressing）。
采用哪种方式由汽车制造商决定。一些汽车制造商还采用与这里解释的方法稍有不同的非常规方法（即与ISO规范不同的分配方式）。

无论哪种情况，要使用CAN进行诊断，至少需要两个CAN-ID，分别用于（物理）请求和响应。
如果要对应前述的功能性寻址请求，则需要再使用一个CAN-ID。
此外，除了前面介绍的请求/响应之外，还有时会分配专用的CAN-ID，用于周期性地发送ECU的内部数据。
通过向诊断测试仪设置这些CAN-ID，如果使用扩展寻址或混合寻址，还需在CAN-ID的基础上设置目标地址的值，从而可以对ECU进行诊断。

·诊断消息的分割发送与接收


https://cdn.vector.com/cms/content/know-how/VJ/PDF/For_Beginners_Diagnostic_Communication.pdf
