Diagnostic Communication
"Diag CAN"是CAN诊断，即对CAN网络各个节点和总线的故障检查与修复。
一、诊断的基本知识
一般来说对于汽车的ECU诊断有以下两种方式：
·on-board diagnostics(OBD,车载诊断系统,オンボード診断)：ECU自我诊断
·off-board diagnostics(离线诊断,オンボード診断):通过和外接的诊断tester通信，接收指示并做出特别动作
（有的时候off-board diagnostics也被叫做OBD）

·诊断connecter
因为在用离线诊断的时候ECU必须和诊断tester连接，把线束(wire harness)改造延长的工作很麻烦，所以设置了专用的connecter。

二、用于诊断的通信
·Diag通信(Diagnostic Communication)
对于Diag通信，从原理上来说怎样的顺序都是可以的。但是各个公司和各个汽车甚至是各个系统的通信顺序总是各种各样的，诊断功能在使用起来比较麻烦。
因此，随着电子控制系统的发展和通信程序的标准化，现在基本上是按照下面的顺序进行的。
①从诊断tester发送请求消息(Request message)作为传达给ECU的指示。
②在指示能够被执行的情况下，ECU按照执行去做并展示出“指示已经被执行”以及“指示执行后的结果”、将它们作为正响应码(positive response message)发送。
③如果因为某种原因指示无法被执行，ECU将展示出“只是无法被执行”以及“无法执行的理由”作为负响应码(NRC, negative response message)发送

ECU无法执行诊断测试器指示的情况有几种可能。
可能是因为请求消息的格式或数据值错误而无法执行指示，或者为了安全考虑而无法执行指示（例如车辆正在行驶）。
当诊断测试器从ECU接收到负响应时，会据此中止一系列的诊断处理。

正响应码和负响应码统称为响应码。另外，请求消息和响应消息合起来称为诊断消息。

·诊断消息的收件人类型
诊断消息一般从一个连接了多个ECU的CAN Bus获取。因此必须要指定诊断消息的收信人。
指定方法有两种，分别是物理寻址(Physical Addressing)和功能寻址(Functional Addressing)。
①物理寻址
这是从一个诊断测试仪向一个ECU传达指令，或者从一个ECU向一个诊断测试仪报告结果的目标指定方法。
所有具有诊断通信功能的ECU都支持物理寻址。使用物理寻址指定的目标称为物理地址。
②功能寻址
这是用于将一个诊断tester的指令传达给一组ECU的目的地指定方法。
所包含的ECU可以只有一个，也可以有多个。设立一个包含总线上所有ECU的组也是很常见的。
通过功能寻址指定的目的地称为功能地址（图6）。
在车辆制造过程中，如果需要删除记录的故障信息，或者在进行ECU重写时，有临时停止重写对象以外的ECU的通信功能等情况，通常希望对总线上的所有ECU执行相同的处理。
此时使用功能寻址，可以通过诊断tester一次性向多个ECU发出指令，从而大幅简化此类处理。
对此，ECU 的响应消息总是发送给发送请求的那台诊断tester，因此只使用物理寻址。



https://cdn.vector.com/cms/content/know-how/VJ/PDF/For_Beginners_Diagnostic_Communication.pdf
